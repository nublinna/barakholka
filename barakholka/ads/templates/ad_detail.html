{% extends 'base.html' %}

{% block title %}{{ ad.title }} - Подробнее{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Левая колонка: Изображение и описание -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100 overflow-hidden"> <!-- Добавил overflow-hidden -->
                <div id="adImageCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-indicators">
                        {% for image in ad.images.all %}
                        <button type="button" data-bs-target="#adImageCarousel" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ forloop.counter }}"></button>
                        {% endfor %}
                    </div>
                    <div class="carousel-inner" style="overflow: hidden;"> <!-- Добавил overflow: hidden -->
                        {% for image in ad.images.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <div class="d-flex justify-content-center align-items-center p-3" style="min-height: 400px; max-height: 600px; background-color: #f8f9fa;">
                                <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-url="{{ image.image.url }}">
                                    <img src="{{ image.image.url }}" class="img-fluid carousel-image" alt="Изображение {{ forloop.counter }}">
                                </a>
                            </div>
                        </div>
                        {% empty %}
                        <div class="carousel-item active">
                            <div class="d-flex justify-content-center align-items-center" style="min-height: 400px; max-height: 600px; background-color: #f8f9fa;">
                                <div class="no-image d-flex align-items-center justify-content-center w-100 h-100">
                                    <i class="bi bi-image text-white" style="font-size: 4rem;"></i>
                                    <span class="visually-hidden">Нет изображения</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if ad.images.count > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#adImageCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Предыдущее</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#adImageCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Следующее</span>
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <h1 class="card-title h2">{{ ad.title }}</h1>
                    <hr>
                    <p class="card-text">{{ ad.description|linebreaksbr }}</p>
                </div>
            </div>
        </div>

        <!-- Правая колонка: Цена, Контакты, Детали -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="card-title text-danger fw-bold mb-3">{{ ad.price }} ₽</h3>
                    <a href="#" class="btn btn-success btn-lg w-100 mb-2"><i class="bi bi-chat-dots"></i> Связаться с продавцом</a>
                    <a href="#" class="btn btn-outline-secondary w-100"><i class="bi bi-heart"></i> Добавить в избранное</a>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">Информация о продавце</div>
                <div class="card-body d-flex align-items-center">
                    <i class="bi bi-person-circle text-muted me-2 fs-4"></i>
                    <h5 class="card-title mb-0">{{ ad.seller.username }}</h5>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light">Детали объявления</div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <span class="badge bg-{% if ad.type == 'new' %}success{% else %}warning{% endif %} me-1">
                                {{ ad.get_type_display }}
                            </span>
                            <span class="badge bg-info text-dark">{{ ad.category }}</span>
                        </li>
                        <li class="text-muted mb-2"><i class="bi bi-geo-alt"></i> {{ ad.address }}</li>
                        <li class="text-muted"><i class="bi bi-clock"></i> {{ ad.created_at|date:"d.m.Y H:i" }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal для полноэкранного просмотра изображения -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">{{ ad.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" id="fullScreenImage" class="img-fluid" alt="{{ ad.title }}" style="max-height: 80vh;">
            </div>
        </div>
    </div>
</div>

{% comment %} Добавим CSS стили {% endcomment %}
{% block extra_css %}
<style>
    /* Исправляем поведение карусели */
    .carousel {
        position: relative;
        width: 100%;
    }

    .carousel-inner {
        position: relative;
        width: 100%;
        overflow: hidden;
        border-radius: 8px 8px 0 0;
        background-color: #f8f9fa; /* Добавляем фон для всего контейнера */
    }

    .carousel-item {
        position: relative;
        display: none;
        float: left;
        width: 100%;
        margin-right: -100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        transition: transform .6s ease-in-out;
    }

    .carousel-item.active,
    .carousel-item-next,
    .carousel-item-prev {
        display: block;
    }

    /* Контейнер для изображения */
    .carousel-image-container {
        width: 100%;
        min-height: 400px;
        max-height: 600px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background-color: #f8f9fa;
    }

    /* Стили для изображений */
    .carousel-image {
        max-width: 100%;
        max-height: 500px;
        height: auto;
        width: auto;
        display: block;
        object-fit: contain;
        margin: 0 auto;
    }

    /* Фиксируем высоту для контейнера изображений */
    .carousel-item > div {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Стили для отсутствующего изображения */
    .no-image {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Убираем transition для изображений, чтобы они не "выпрыгивали" */
    .carousel-item img {
        transition: none !important;
    }

    /* Адаптивность */
    @media (max-width: 768px) {
        .carousel-image-container {
            min-height: 300px;
            max-height: 400px;
            padding: 15px;
        }

        .carousel-image {
            max-height: 350px;
        }
    }

    @media (max-width: 576px) {
        .carousel-image-container {
            min-height: 250px;
            max-height: 350px;
            padding: 10px;
        }

        .carousel-image {
            max-height: 300px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var imageModal = document.getElementById('imageModal');
        if (imageModal) {
            imageModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var imageUrl = button.getAttribute('data-image-url');
                var fullScreenImage = imageModal.querySelector('#fullScreenImage');
                if (fullScreenImage && imageUrl) {
                    fullScreenImage.src = imageUrl;
                }
            });
        }

        // Дополнительный скрипт для предотвращения "выпрыгивания" изображений
        var carousel = document.getElementById('adImageCarousel');
        if (carousel) {
            // Останавливаем автоматическую прокрутку
            carousel.pause();

            // Добавляем обработчик события slide
            carousel.addEventListener('slide.bs.carousel', function() {
                // Принудительно фиксируем высоту контейнера
                var activeItem = this.querySelector('.carousel-item.active');
                var nextItem = this.querySelector('.carousel-item-next');
                var prevItem = this.querySelector('.carousel-item-prev');

                if (activeItem) {
                    var img = activeItem.querySelector('img');
                    if (img) {
                        img.style.transition = 'none';
                    }
                }
            });

            // Добавляем обработчик события slid (после завершения перехода)
            carousel.addEventListener('slid.bs.carousel', function() {
                // Восстанавливаем стандартное поведение
                var activeItem = this.querySelector('.carousel-item.active');
                if (activeItem) {
                    var img = activeItem.querySelector('img');
                    if (img) {
                        // Небольшая задержка перед восстановлением transition
                        setTimeout(function() {
                            img.style.transition = '';
                        }, 50);
                    }
                }
            });
        }
    });
</script>
{% endblock %}
{% endblock %}